<?php/*Plugin Name: WP-registration-by-emailDescription: Change the registration procedure so that users have to confirm their e-mail by clicking an activation link.Author: Steve MarsdenVersion: 1.0Author URI: http://dradge.com*/// Note! This plugin needs wp-members plugin to work properly.// It adds functionality to the wp-members plugin so you can send HTML confirmation emails.
add_action('user_register','update_the_fields');function update_the_fields($user_id,$password="", $meta=array()) {	/* Update user data - in this case, the password they chose */	$userdata = array();	$userdata['ID'] = $user_id;	if($_POST['password']){		$userdata['user_pass'] = $_POST['password'];	}	wp_update_user($userdata);	/* Create activation key, by hashing time and user email (and, if you like, a random string for added security) */	//$user_info = get_user_by('login',$user_id);	//$confirmkey = md5(strval(time()).$user_info->user_email);	//$confirmkey = "new";	//add_user_meta( $user_id, 'confirmed', "", true );}/** Custom authentication* When a user logs in we can make further checks* In this example, I check to see if a user needs to activate their account (i.e. has an activation key)*/add_filter( 'authenticate', 'my_custom_function', 10, 3 );function my_custom_function( $user, $username, $password ){	$user = get_user_by('login', $username);	if ($username!=""){		$value = get_user_meta($user->ID, 'confirmed', true);		if($value!=null){			//$error = new WP_Error( 'denied', __("<strong>ERROR</strong>: You need to activate your account.") );//create an error			remove_action('authenticate', 'wp_authenticate_username_password', 20); //key found - don't proceed!		}	}	return null;}add_filter('query_vars', 'add_my_queryvars');function add_my_queryvars ($qvars){	$qvars[] = 'confirmed';	return $qvars;}add_filter( 'wpmem_email_headers', 'html_email' );function html_email() {    return "Content-Type: text/html";}add_action( 'wpmem_post_register_data', 'globalize_wpmem_fields' );function globalize_wpmem_fields( $fields ) {	global $wpmem_global_fields;	$wpmem_global_fields = $fields;}add_filter( 'wpmem_email_newreg', 'my_email_filter' );
function my_email_filter( $email_body ) {	global $wpmem_global_fields;	$yourID  = $wpmem_global_fields['ID'];	$authCheck = wp_create_nonce( 'auth_'.$yourID );	add_user_meta( $yourID, 'authcheck', $authCheck);	$activationlink = site_url()."/membercenter/member-activation?confirmed=$authCheck";	add_user_meta($yourID, 'activation_guid', $activationlink, true);	$ufirst = get_user_meta($yourID, 'first_name', true);	$ulast = get_user_meta($yourID, 'last_name', true);	$email_body = "$ufirst $ulast,<br>$email_body";	$email_body = str_replace("~activationlink~", $activationlink, $email_body);	return $email_body;}
?>